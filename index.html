<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>HTMLãƒãƒ³ï¼šãƒãƒ‹ãƒ¥ã‚¢ãƒ«ãƒ»ã‚¤ãƒ³ãƒ‘ã‚¯ãƒˆè§£æ</title>
    <style>
        :root { --accent: #ffcc00; --bg: #121212; --panel: #1e1e1e; }
        body { font-family: sans-serif; background: var(--bg); color: white; margin: 0; padding: 20px; text-align: center; }
        .container { max-width: 600px; margin: auto; }
        video { width: 100%; border-radius: 10px; background: #000; margin-bottom: 10px; }
        .control-panel { background: var(--panel); padding: 15px; border-radius: 15px; margin-bottom: 10px; }
        .frame-ctrl { display: flex; justify-content: center; gap: 10px; margin: 10px 0; }
        button { padding: 12px; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; transition: 0.2s; }
        .btn-main { background: #007aff; color: white; width: 100%; margin-bottom: 10px; }
        .btn-frame { background: #444; color: white; flex: 1; }
        .btn-set { background: var(--accent); color: #000; flex: 1; }
        .result-box { background: #2c2c2e; padding: 20px; border-radius: 15px; border: 1px solid var(--accent); }
        .speed-large { font-size: 2.5rem; color: var(--accent); font-weight: bold; }
        .info { font-size: 0.8rem; color: #aaa; margin-bottom: 10px; }
    </style>
</head>
<body>

<div class="container">
    <h2>ğŸŒï¸â€â™‚ï¸ Manual Speed Analyzer</h2>
    <div class="info" id="status">1. ã‚«ãƒ¡ãƒ©ã‚’èµ·å‹•ã—ã¦éŒ²ç”»ã—ã¦ãã ã•ã„</div>

    <video id="videoPlayer" autoplay muted playsinline></video>

    <div class="control-panel">
        <button id="recBtn" class="btn-main">ã‚«ãƒ¡ãƒ©ã‚’èµ·å‹• / éŒ²ç”»</button>
        
        <div id="manualUI" style="display:none;">
            <div class="info">å‹•ç”»ã‚’æ­¢ã‚ã¦ã€1ãƒ•ãƒ¬ãƒ¼ãƒ ãšã¤å‹•ã‹ã—ã¦ã‚¤ãƒ³ãƒ‘ã‚¯ãƒˆå‰å¾Œã‚’æŒ‡å®š</div>
            <div class="frame-ctrl">
                <button class="btn-frame" onclick="changeFrame(-0.033)">â—€ æˆ»ã‚‹</button>
                <button class="btn-frame" onclick="togglePlay()">å†ç”Ÿ/ä¸€æ™‚åœæ­¢</button>
                <button class="btn-frame" onclick="changeFrame(0.033)">é€²ã‚€ â–¶</button>
            </div>
            <div class="frame-ctrl">
                <button class="btn-set" onclick="setPoint('A')">åœ°ç‚¹A (ã‚¤ãƒ³ãƒ‘ã‚¯ãƒˆç›´å‰)</button>
                <button class="btn-set" onclick="setPoint('B')">åœ°ç‚¹B (ã‚¤ãƒ³ãƒ‘ã‚¯ãƒˆç›´å¾Œ)</button>
            </div>
        </div>
    </div>

    <div class="result-box">
        <div id="speedResult" class="speed-large">--.- m/s</div>
        <div id="subResult">-- km/h</div>
    </div>
</div>

<script>
    const video = document.getElementById('videoPlayer');
    const recBtn = document.getElementById('recBtn');
    const status = document.getElementById('status');
    const manualUI = document.getElementById('manualUI');
    
    let stream, recorder, chunks = [];
    let pointA = null, pointB = null;

    // --- éŒ²ç”»æ©Ÿèƒ½ ---
    recBtn.onclick = async () => {
        if (!stream) {
            stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } });
            video.srcObject = stream;
            recBtn.innerText = "éŒ²ç”»é–‹å§‹";
            status.innerText = "æº–å‚™å®Œäº†";
            return;
        }

        if (recBtn.innerText === "éŒ²ç”»é–‹å§‹") {
            chunks = [];
            recorder = new MediaRecorder(stream);
            recorder.ondataavailable = e => chunks.push(e.data);
            recorder.onstop = () => {
                const blob = new Blob(chunks, { type: 'video/webm' });
                video.srcObject = null;
                video.src = URL.createObjectURL(blob);
                video.controls = false;
                manualUI.style.display = 'block';
                status.innerText = "ã‚³ãƒé€ã‚Šã§ã‚¤ãƒ³ãƒ‘ã‚¯ãƒˆå‰å¾Œã‚’é¸ã‚“ã§ãã ã•ã„";
            };
            recorder.start();
            recBtn.innerText = "éŒ²ç”»åœæ­¢";
            status.innerText = "éŒ²ç”»ä¸­...";
        } else {
            recorder.stop();
            recBtn.innerText = "å†æ’®å½±";
        }
    };

    // --- ã‚³ãƒé€ã‚Šãƒ»è§£ææ©Ÿèƒ½ ---
    function togglePlay() {
        video.paused ? video.play() : video.pause();
    }

    function changeFrame(sec) {
        video.pause();
        video.currentTime += sec;
    }

    function setPoint(label) {
        if (label === 'A') {
            pointA = video.currentTime;
            status.innerText = "åœ°ç‚¹Aå›ºå®š: " + pointA.toFixed(3) + "s";
        } else {
            pointB = video.currentTime;
            status.innerText = "åœ°ç‚¹Bå›ºå®š: " + pointB.toFixed(3) + "s";
            calculate();
        }
    }

    function calculate() {
        if (pointA === null || pointB === null) return;
        const dt = Math.abs(pointB - pointA);
        if (dt === 0) return;

        // ã€ã‚´ãƒ«ãƒ•æŒ‡å°è€…ã®ãƒ­ã‚¸ãƒƒã‚¯ã€‘
        // ã‚¤ãƒ³ãƒ‘ã‚¯ãƒˆç›´å‰ï¼ˆãƒ˜ãƒƒãƒ‰ãŒãƒœãƒ¼ãƒ«ã«è§¦ã‚Œã‚‹å¯¸å‰ï¼‰ã‹ã‚‰
        // ç›´å¾Œï¼ˆãƒœãƒ¼ãƒ«ãŒé›¢ã‚ŒãŸç¬é–“ï¼‰ã®ç§»å‹•è·é›¢ã‚’ç´„ 60cm(0.6m) ã¨ä»®å®š
        const distance = 0.6; 
        const speedMs = distance / dt;
        const speedKmh = speedMs * 3.6;

        document.getElementById('speedResult').innerText = speedMs.toFixed(1) + " m/s";
        document.getElementById('subResult').innerText = "æ™‚é€Ÿ " + speedKmh.toFixed(1) + " km/h (æ™‚é–“å·®: " + (dt*1000).toFixed(0) + "ms)";
    }
</script>
</body>
</html>
