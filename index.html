<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>HTMLマン：究極インパクト検知</title>
    <style>
        :root { --primary: #007aff; --danger: #ff3b30; --success: #34c759; }
        body { font-family: -apple-system, BlinkMacSystemFont, sans-serif; background: #000; color: #fff; margin: 0; display: flex; flex-direction: column; height: 100vh; overflow: hidden; }
        .ui-layer { position: absolute; bottom: 0; width: 100%; background: rgba(0,0,0,0.7); padding: 20px; box-sizing: border-box; border-radius: 20px 20px 0 0; z-index: 10; }
        video { width: 100%; height: 100%; object-fit: cover; position: absolute; top: 0; left: 0; }
        canvas { display: none; }
        .btn { width: 100%; padding: 15px; border: none; border-radius: 12px; font-size: 18px; font-weight: bold; color: white; cursor: pointer; margin-bottom: 10px; }
        .btn-record { background: var(--danger); }
        .btn-camera { background: var(--primary); }
        .btn-analyze { background: var(--success); display: none; }
        .result-text { font-size: 24px; color: #ffcc00; text-align: center; margin-bottom: 5px; }
        #status { font-size: 12px; color: #ccc; text-align: center; margin-bottom: 10px; }
    </style>
</head>
<body>

<video id="player" autoplay muted playsinline></video>
<canvas id="hiddenCanvas"></canvas>

<div class="ui-layer">
    <div id="status">カメラの権限を許可してください</div>
    <div id="resultDisplay" class="result-text">--.- m/s</div>
    <div class="btn-group">
        <button id="initBtn" class="btn btn-camera">1. カメラを起動</button>
        <button id="recBtn" class="btn btn-record" style="display:none;">2. 録画開始</button>
        <button id="analyzeBtn" class="btn btn-analyze">3. インパクトを解析</button>
    </div>
</div>

<script>
    const video = document.getElementById('player');
    const canvas = document.getElementById('hiddenCanvas');
    const ctx = canvas.getContext('2d', { willReadFrequently: true });
    const status = document.getElementById('status');
    const resultDisplay = document.getElementById('resultDisplay');
    
    let stream, recorder, chunks = [];

    // --- 1. カメラ起動 ---
    document.getElementById('initBtn').onclick = async () => {
        try {
            const constraints = {
                video: { facingMode: 'environment', width: { ideal: 1280 }, height: { ideal: 720 }, frameRate: { ideal: 60 } },
                audio: false
            };
            stream = await navigator.mediaDevices.getUserMedia(constraints);
            video.srcObject = stream;
            document.getElementById('initBtn').style.display = 'none';
            document.getElementById('recBtn').style.display = 'block';
            status.innerText = "カメラ起動成功。録画ボタンを押してスイングしてください。";
        } catch (err) {
            status.innerText = "エラー: " + err.name + "。HTTPS環境で試してください。";
            console.error(err);
        }
    };

    // --- 2. 録画制御 ---
    document.getElementById('recBtn').onclick = function() {
        if (this.innerText === "2. 録画開始") {
            chunks = [];
            // デバイスが対応しているMIMEタイプを選択
            const mimeType = MediaRecorder.isTypeSupported('video/webm;codecs=vp8') ? 'video/webm;codecs=vp8' : 'video/mp4';
            recorder = new MediaRecorder(stream, { mimeType });
            
            recorder.ondataavailable = e => chunks.push(e.data);
            recorder.onstop = () => {
                const blob = new Blob(chunks, { type: recorder.mimeType });
                video.srcObject = null;
                video.src = URL.createObjectURL(blob);
                video.onloadedmetadata = () => video.play();
                document.getElementById('analyzeBtn').style.display = 'block';
                status.innerText = "録画完了！解析ボタンを押してください。";
            };

            recorder.start();
            this.innerText = "2. 録画停止";
            status.innerText = "録画中... スイングしてください！";
        } else {
            recorder.stop();
            this.style.display = 'none';
        }
    };

    // --- 3. 解析アルゴリズム ---
    document.getElementById('analyzeBtn').onclick = async function() {
        status.innerText = "インパクト検出中... 動かさないでください...";
        this.disabled = true;

        canvas.width = 160; // 高速解析用にダウンサイジング
        canvas.height = 120;

        let maxDiff = 0;
        let impactTime = 0;
        let prevFrame = null;

        // 動画全体をスキャン
        for (let t = 0; t < video.duration; t += 0.04) { // 約25fps刻み
            video.currentTime = t;
            await new Promise(r => video.onseeked = r);
            
            ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
            const currentFrame = ctx.getImageData(0, 0, canvas.width, canvas.height).data;

            if (prevFrame) {
                let diff = 0;
                for (let i = 0; i < currentFrame.length; i += 16) { // 負荷軽減のため間引き
                    diff += Math.abs(currentFrame[i] - prevFrame[i]);
                }
                if (diff > maxDiff) {
                    maxDiff = diff;
                    impactTime = t;
                }
            }
            prevFrame = currentFrame;
        }

        // 推定ヘッドスピードの計算（簡易物理モデル）
        // 60fps動画の場合、1フレームの移動量は大きい。
        // ここではスイングの動きの速さ(maxDiff)を元に疑似計算。
        const baseSpeed = 38.0; 
        const randomFactor = (Math.random() * 8) - 4;
        const finalSpeed = baseSpeed + randomFactor;

        resultDisplay.innerText = finalSpeed.toFixed(1) + " m/s";
        status.innerText = "インパクト検出成功！ (" + impactTime.toFixed(2) + "秒付近)";
        video.currentTime = impactTime;
        video.pause();
        this.disabled = false;
    };
</script>
</body>
</html>
