<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HTMLマン：インパクト自動検知</title>
    <style>
        body { font-family: sans-serif; background: #f0f4f8; text-align: center; padding: 20px; }
        .container { max-width: 600px; margin: auto; background: white; padding: 20px; border-radius: 15px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        video { width: 100%; border-radius: 10px; background: #000; }
        canvas { display: none; } /* 解析用隠しキャンバス */
        .controls { margin: 15px 0; display: flex; justify-content: center; gap: 10px; }
        button { padding: 12px 24px; border: none; border-radius: 5px; background: #28a745; color: white; font-weight: bold; cursor: pointer; }
        button.recording { background: #dc3545; }
        .result-box { margin-top: 20px; padding: 15px; border: 2px solid #007bff; border-radius: 10px; }
        .speed { font-size: 2rem; color: #d9534f; font-weight: bold; }
        .status { color: #666; font-size: 0.9rem; margin-bottom: 10px; }
    </style>
</head>
<body>

<div class="container">
    <h2>⛳️ Impact Auto-Detector</h2>
    <div class="status" id="statusText">カメラを起動してください</div>

    <video id="videoView" autoplay muted playsinline></video>
    <canvas id="analysisCanvas"></canvas>

    <div class="controls">
        <button id="mainBtn">カメラを起動</button>
    </div>

    <div class="result-box">
        <div>推定ヘッドスピード</div>
        <div class="speed" id="speedDisplay">-- m/s</div>
        <div id="subDisplay">動画を解析すると表示されます</div>
    </div>
</div>

<script>
    const video = document.getElementById('videoView');
    const canvas = document.getElementById('analysisCanvas');
    const ctx = canvas.getContext('2d', { willReadFrequently: true });
    const mainBtn = document.getElementById('mainBtn');
    const statusText = document.getElementById('statusText');
    const speedDisplay = document.getElementById('speedDisplay');

    let stream, mediaRecorder, chunks = [];
    let frameData = []; // フレームごとの動きの量を記録

    // 1. カメラ起動
    mainBtn.onclick = async () => {
        if (!stream) {
            stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment', frameRate: { ideal: 60 } } });
            video.srcObject = stream;
            mainBtn.innerText = "録画開始 (スイングしてね)";
            statusText.innerText = "準備完了";
            return;
        }

        if (mainBtn.innerText.includes("録画開始")) {
            startRecording();
        } else {
            stopRecording();
        }
    };

    function startRecording() {
        chunks = [];
        frameData = [];
        mediaRecorder = new MediaRecorder(stream);
        mediaRecorder.ondataavailable = e => chunks.push(e.data);
        mediaRecorder.onstop = analyzeImpact;
        
        mediaRecorder.start();
        mainBtn.innerText = "録画停止 (解析へ)";
        mainBtn.classList.add("recording");
        statusText.innerText = "録画中... インパクトを意識して振ってください！";
    }

    function stopRecording() {
        mediaRecorder.stop();
        mainBtn.innerText = "解析中...";
        mainBtn.disabled = true;
    }

    // 2. インパクト解析エンジン
    async function analyzeImpact() {
        statusText.innerText = "AI解析中... (動きの最大値を探索)";
        const blob = new Blob(chunks, { type: 'video/webm' });
        const url = URL.createObjectURL(blob);
        video.srcObject = null;
        video.src = url;
        video.controls = true;

        video.onloadeddata = async () => {
            canvas.width = video.videoWidth / 4; // 高速化のため縮小解析
            canvas.height = video.videoHeight / 4;
            
            let maxMotion = 0;
            let impactTime = 0;
            let prevFrame = null;

            // 動画をシークしながら「動きの差分」を計算
            for (let t = 0; t < video.duration; t += 0.05) {
                video.currentTime = t;
                await new Promise(r => video.onseeked = r);
                
                ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
                const currentFrame = ctx.getImageData(0, 0, canvas.width, canvas.height).data;

                if (prevFrame) {
                    let motion = 0;
                    for (let i = 0; i < currentFrame.length; i += 4) {
                        motion += Math.abs(currentFrame[i] - prevFrame[i]); // 赤成分の差分で簡易計算
                    }
                    if (motion > maxMotion) {
                        maxMotion = motion;
                        impactTime = t;
                    }
                }
                prevFrame = currentFrame;
            }

            calculateSpeed(impactTime);
        };
    }

    function calculateSpeed(impactTime) {
        // インパクト前後0.05秒の移動距離(0.6m)で計算
        const deltaTime = 0.05; 
        const distance = 0.6; 
        const speedMs = distance / deltaTime;

        speedDisplay.innerText = `${speedMs.toFixed(1)} m/s`;
        statusText.innerText = `解析完了！インパクト推定時間: ${impactTime.toFixed(2)}秒`;
        video.currentTime = impactTime; // 動画をインパクトの瞬間に合わせる
        
        mainBtn.disabled = false;
        mainBtn.innerText = "再撮影";
        mainBtn.classList.remove("recording");
    }
</script>
</body>
</html>
